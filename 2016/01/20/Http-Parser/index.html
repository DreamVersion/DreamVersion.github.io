<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 有限状态机解析Http报文 · MelonQi Blog</title><meta name="description" content="有限状态机解析Http报文 - MelonQi"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://melonqi.cn/atom.xml" title="MelonQi Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">有限状态机解析Http报文</h1><div class="post-info">Jan 20, 2016</div><div class="post-content"><p>Http报文解析是做后台和客户端都是必须的，其实就是字符串处理，使用查找子串的方式肯定会慢很多，这对追求性能的C++来说是不能接受，所以引入只需要遍历一遍的有限状态机的方式来解析。<br><a id="more"></a><br>HTTP请求格式:</p>
<blockquote>
<p><code>&lt;request-line&gt;</code><br><code>&lt;headers&gt;</code><br><code>&lt;blank line&gt;</code><br><code>[&lt;request-body&gt;]</code></p>
</blockquote>
<p>说明: 第一行必须是一个请求行(request-line),用来说明请求类型,要访问的资源以及所使用的HTTP版本. 紧接着是一个首部(header)小节,用来说明服务器要使用的附加信息.之后是一个空行. 再后面可以添加任意的其他数据[称之为主体(body)].<br>举例：</p>
<blockquote>
<p><code>GET / HTTP/1.1</code><br><code>Accept: */*</code><br><code>Accept-Language: zh-cn</code><br><code>Accept-Encoding: gzip, deflate</code><br><code>User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)</code><br><code>Host: www.google.cn</code><br><code>Connection: Keep-Alive</code></p>
</blockquote>
<p>说明: 请求的第一部分说明了该请求是一个GET请求. 该行的第二部分是一个斜杠(/),用来说明请求的是该域名的根目录. 该行的最后一部分说明使用的是HTTP1.1版本(另一个可选荐是1.0).</p>
<p>第2行是请求的第一个首部,HOST将指出请求的目的地. User-Agent,服务器端和客户端脚本都能访问它,它是浏览器类型检测逻辑的重要基础. 该信息由你的浏览器来定义, 并且在每个请求中自动发送. Connection,通常将浏览器操作设置为Keep-Alive</p>
<p>第三部分,空行,即使不存在请求主体,这个空行也是必需的.</p>
<h2 id="u6709_u9650_u72B6_u6001_u673A"><a href="#u6709_u9650_u72B6_u6001_u673A" class="headerlink" title="有限状态机"></a>有限状态机</h2><p>有限状态机(FSM：Finite State Machine)，简称状态机，是表示有限多个状态以及在这些状态之间转移和动作的数学模型。状态存储关于过去的信息，它反映从系统开始到现在时刻输入的变化；转移指示状态变更，用必须满足来确使转移发生的条件来描述它；动作是在给定时刻要进行的活动描述。</p>
<p>有多种类型的动作：</p>
<ul>
<li>进入动作（entry action）：在进入状态时进行；</li>
<li>退出动作：在退出状态时进行；</li>
<li>输入动作：依赖于当前状态和输入条件进行；</li>
<li>转移动作：在特定转移时进行。</li>
</ul>
<p>状态机最重要的两个概念是：状态和转移。状态是程序所处的某个状态，比如TCP链接的时候出于要接受链接状态。再某个状态下，如果有特定的条件发生，程序将会转移到另外的状态。<br>举一个生活中最常见的例子：我们每一天的状态基本上都是睡眠，起床，吃饭，工作，吃饭，工作，吃饭，休闲，睡眠；其中睡眠，吃饭，等都是我们所处的状态，状态之间的转移需要一些条件的发生，比如睡眠到起床需要8:00的到来。当然也会有一些动作产生，我们这里就忽略动作。<br>用椭圆代表状态，箭头代表状态转移，箭头上方的文字代表是条件。<br>用状态转移图表示一天的流程：<br><img src="http://7xpwmi.com1.z0.glb.clouddn.com/wholeday.png" alt="一天的流程"><br>最常见的状态机是TCP的状态机。<br><img src="http://7xpwmi.com1.z0.glb.clouddn.com/TCP_AC.png" alt="TCP状态机"></p>
<h2 id="Parser_u7C7B"><a href="#Parser_u7C7B" class="headerlink" title="Parser类"></a>Parser类</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> Parser</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Parser(<span class="keyword">char</span> *data,<span class="keyword">int</span> len):</span><br><span class="line">            packet(data),length(len)&#123;</span><br><span class="line">        parse_packet();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; getParameters();<span class="comment">//查询所有的Key</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">getValueByParameter</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">string</span> parameter)</span></span>;<span class="comment">//查询Key对应的Value</span></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">getVersion</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> version;&#125;<span class="comment">//获得http版本</span></span><br><span class="line">    <span class="keyword">inline</span> <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">getMethod</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> method;&#125;<span class="comment">//获取http方法</span></span><br><span class="line">    <span class="keyword">inline</span> <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">getUri</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> uri;&#125;<span class="comment">//获取uri</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">parse_packet</span><span class="params">()</span></span>;<span class="comment">//解析整个http包</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">parse_header_line</span><span class="params">()</span></span>;<span class="comment">//解析headers line</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">parse_request_line</span><span class="params">()</span></span>;<span class="comment">//解析request line</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">int</span> length; <span class="comment">//http长度</span></span><br><span class="line">    <span class="keyword">int</span> version; <span class="comment">//Http版本</span></span><br><span class="line">    <span class="keyword">char</span> *packet;<span class="comment">//http数据包</span></span><br><span class="line">    <span class="keyword">char</span> *pos;<span class="comment">//解析时，记录已解析的位置</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> method;<span class="comment">//http方法</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> uri;<span class="comment">// uri</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>, <span class="built_in">std</span>::<span class="built_in">string</span>&gt; KVMap;<span class="comment">//存放headers中的KeyValue对</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="u89E3_u6790_u6574_u4F53"><a href="#u89E3_u6790_u6574_u4F53" class="headerlink" title="解析整体"></a>解析整体</h2><p>一行一行解析，先解析request line，后解析headers直到碰到空白行。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> Parser::parse_packet()</span><br><span class="line">&#123;</span><br><span class="line">    pos = packet;</span><br><span class="line">    <span class="keyword">int</span> ret = parse_request_line();</span><br><span class="line">    <span class="keyword">switch</span>(ret) &#123;</span><br><span class="line">        <span class="keyword">case</span> HTTP_PARSE_INVALID_REQUEST:</span><br><span class="line">        <span class="keyword">case</span> HTTP_PARSE_IGNORED_METHOD:</span><br><span class="line">            <span class="keyword">return</span> HTTP_ERR;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(;;)</span><br><span class="line">    &#123;</span><br><span class="line">        ret = parse_header_line();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ret == HTTP_PARSE_HEADER_DONE) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ret == HTTP_PARSE_AGAIN &amp;&amp; HTTP_PARSE_INVALID_HEADER == ret) &#123;</span><br><span class="line">            <span class="keyword">return</span> HTTP_ERR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="u89E3_u6790headers"><a href="#u89E3_u6790headers" class="headerlink" title="解析headers"></a>解析headers</h2><p>Http请求报文中的headers部分是由多行组成，其中每行都是KeyValue格式，具体格式为<code>name: value \r\n</code>. 注意有空白行<code>\r\n</code>，也需要加入到状态机中。<br><img src="http://7xpwmi.com1.z0.glb.clouddn.com/ac.png" alt="有限状态机"><br>状态解析：</p>
<ol>
<li>start是程序的开始，在此状态下，如果字符是<code>\r</code>，则有可能是空白行，整个headers的部分就快解析完成，就会进入到headers almost done状态；若是其他字符，状态就会迁移到name状态。当然这里省略了不合法字符的状态迁移，比如在start状态时的字符是<code>\n</code>，说明整个headers都是不合法的，导致程序会退出。</li>
<li>name状态说明程序正在解析Key部分，记录进入name状态的第一个字符位置和出name状态的最后一个字符位置，最终可以得到name字段。在name状态中若接受到的字符是’:’，说明name解析完成，将会进入到space before value状态；若接收到除了<code>\r</code>和<code>\n</code>以外的字符，说明只解析了Key的一部分，仍然停留在name状态。</li>
<li>在space before value状态中，用于去除value开头多余的空格。在此状态只要接受的都是’ ‘，就将保留在此状态。其他字符将会进入value状态。</li>
<li>在value状态将会得到Value值，需要记录一下进入value状态和出value状态的字符位置。当字符是’ ‘时，可能代表了value的解析完成，就进入到space after value;</li>
<li>在space after value状态中，若字符是’ ‘，继续停留在此状态；若是除了<code>\r</code>,<code>\0</code>和<code>\n</code>，将进入到value状态，因为在Value中也可能出现’ ‘。</li>
<li>在name，space before value，value，space after value状态接受到<code>\r</code>都会进入到almost done状态，代表一行的解析差不多结束了。</li>
<li>在almost done状态时，想要接受的字符是<code>\n</code>，才能正常结束；若接受到<code>\r</code>，持续停留在这个状态。</li>
<li>有一些细节可能没有处理，比如对<code>\0</code>字符的处理等等，需要参考HTTP标准，多增加状态来处理，这里就忽略。</li>
</ol>
<p>相关代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> Parser::parse_header_line()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">enum</span> &#123;</span><br><span class="line">        sw_start = <span class="number">0</span>,</span><br><span class="line">        sw_name,</span><br><span class="line">        sw_space_before_value,</span><br><span class="line">        sw_value,</span><br><span class="line">        sw_space_after_value,</span><br><span class="line">        sw_ignore_line,</span><br><span class="line">        sw_almost_done,</span><br><span class="line">        sw_header_almost_done</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> ch, *p=<span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">uint32_t</span> state = sw_start;</span><br><span class="line">    <span class="keyword">char</span> *header_name_start=<span class="literal">NULL</span>,*header_name_end=<span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">char</span> *header_start=<span class="literal">NULL</span>,*header_end=<span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(p = pos; p &lt; packet +length; p++)</span><br><span class="line">    &#123;</span><br><span class="line">        ch = *p;</span><br><span class="line">        <span class="keyword">switch</span>(state)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> sw_start:</span><br><span class="line">            &#123;</span><br><span class="line">                header_name_start = p;</span><br><span class="line">                <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">                    <span class="keyword">case</span> CR:</span><br><span class="line">                        header_end = p;</span><br><span class="line">                        state = sw_header_almost_done;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> LF:</span><br><span class="line">                        header_end = p;</span><br><span class="line">                        pos = p + <span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">return</span> HTTP_PARSE_HEADER_DONE;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        state = sw_name;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> sw_name:</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">switch</span>(ch)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">':'</span>:</span><br><span class="line">                        header_name_end = p;</span><br><span class="line">                        state = sw_space_before_value;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> CR:</span><br><span class="line">                        header_name_end = p;</span><br><span class="line">                        header_start = p;</span><br><span class="line">                        header_end = p;</span><br><span class="line">                        state = sw_almost_done;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> LF:</span><br><span class="line">                        header_name_end = p;</span><br><span class="line">                        header_start = p;</span><br><span class="line">                        header_end = p;</span><br><span class="line">                        pos = p + <span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> sw_space_before_value:</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">' '</span>:</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> CR:</span><br><span class="line">                        header_start = p;</span><br><span class="line">                        header_end = p;</span><br><span class="line">                        state = sw_almost_done;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> LF:</span><br><span class="line">                        header_start = p;</span><br><span class="line">                        header_end = p;</span><br><span class="line">                        pos = p + <span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">'\0'</span>:</span><br><span class="line">                        <span class="keyword">return</span> HTTP_PARSE_INVALID_HEADER;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        header_start = p;</span><br><span class="line">                        state = sw_value;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> sw_value:</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">' '</span>:</span><br><span class="line">                        header_end = p;</span><br><span class="line">                        state = sw_space_after_value;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> CR:</span><br><span class="line">                        header_end = p;</span><br><span class="line"></span><br><span class="line">                        state = sw_almost_done;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> LF:</span><br><span class="line">                        header_end = p;</span><br><span class="line">                        pos = p + <span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">'\0'</span>:</span><br><span class="line">                        <span class="keyword">return</span> HTTP_PARSE_INVALID_HEADER;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> sw_space_after_value:</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">' '</span>:</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> CR:</span><br><span class="line"></span><br><span class="line">                        state = sw_almost_done;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> LF:</span><br><span class="line">                        pos = p + <span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">'\0'</span>:</span><br><span class="line">                        <span class="keyword">return</span> HTTP_PARSE_INVALID_HEADER;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        state = sw_value;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> sw_ignore_line:</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">                    <span class="keyword">case</span> LF:</span><br><span class="line">                        state = sw_start;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> sw_almost_done:</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">                    <span class="keyword">case</span> LF:</span><br><span class="line">                        pos = p + <span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">if</span>(header_name_start!=<span class="literal">NULL</span></span><br><span class="line">                           &amp;&amp;header_name_end&gt;header_name_start</span><br><span class="line">                           &amp;&amp; header_start!=<span class="literal">NULL</span></span><br><span class="line">                           &amp;&amp; header_end&gt;header_start)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="built_in">std</span>::<span class="built_in">string</span> key = <span class="built_in">std</span>::<span class="built_in">string</span>(header_name_start,header_name_end-header_name_start);</span><br><span class="line">                            <span class="built_in">std</span>::<span class="built_in">string</span> value = <span class="built_in">std</span>::<span class="built_in">string</span>(header_start,header_end-header_start);</span><br><span class="line">                            KVMap[key]=value;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">case</span> CR:</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">return</span> HTTP_PARSE_INVALID_HEADER;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> sw_header_almost_done:</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">                    <span class="keyword">case</span> LF:</span><br><span class="line">                        pos = p + <span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">return</span> HTTP_PARSE_HEADER_DONE;</span><br><span class="line">                    <span class="keyword">case</span> CR:</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">return</span> HTTP_PARSE_INVALID_HEADER;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pos = p;</span><br><span class="line">    <span class="keyword">return</span> HTTP_PARSE_AGAIN;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="u89E3_u6790request-line"><a href="#u89E3_u6790request-line" class="headerlink" title="解析request-line"></a>解析request-line</h2><p>Http请求报文中的headers部分的格式是<code>method uri version\r\n</code>,原理相同，但是代码相对较长，就省略了，详细代码请参考：<a href="http://7xpwmi.com1.z0.glb.clouddn.com/http_parser.zip" target="_blank" rel="external">http_parser</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2016/03/18/syslog/" class="prev">上一篇</a><a href="/2016/01/16/Makefile/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2017 <a href="http://melonqi.cn">MelonQi</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>